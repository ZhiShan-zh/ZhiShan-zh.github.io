# 读写分离

# 1 读写分离的基本原理

读写分离的基本原理是将数据库的读写操作分散到不同的节点上，基本架构如下图所示：

![](https://zhishan-zh.github.io/media/database_readwriteseparation_20200713165919.png)

# 2 读写分离基本实现

## 2.1 实现思路

1. 数据库服务器搭建主从集群，一主一从、一主多从都合一
2. 数据库主机负责读写操作，从机只负责读操作
3. 数据库主机通过复制将数据同步到从机，每台数据库服务器都存储了所有的业务数据
4. 业务服务器将写操作发给数据库主机，将读操作发给数据库从机

## 2.2 主从复制实现方法

- 数据库的主从复制机制（master-slave）
    - 需要注意：一个master多个slave会增大master的负担。
- 使用Canal
    - Canal是阿里开源的一款基于MySQL数据库binlog的增量订阅和消费组件。

## 2.3 主从复制的问题

读写分离的实现逻辑并不复杂，但是在实际应用的过程中需要应对复制延迟带来的复杂性。

> 说明：以mysql为例，主从复制的延迟可能达到1s，如果有大量的数据同步，延迟1分钟以上也是
> 有可能的，主从复制的延迟会带来一个问题：如果业务服务器将数据库写入到数据库主服务器后立
> 刻进行读取，此时读操作访问的是从机，主机还没有将数据复制过来，到从机读取的数据不是最新
> 的数据，业务上就会有问题。例如 用户注册成功后，立即登录，提示用户不存在。

应对方案：

- 写操作完成后的读操作指定发给数据库的主服务器。(需要和业务进行强绑定，对业务的
    侵入和影响较大)
- 读取从机失败后在读取一次主机。(需要对底层数据库访问API进行封装)
- 关键性业务读写操作全部指向主机，非关键性业务采用读写分离。