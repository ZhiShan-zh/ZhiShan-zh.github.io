# Redis中的数据逐出策略

# 1 概述

Redis使用内存存储数据，在执行每一个命令前，会调用freeMemoryIfNeeded()检测内存是否充足。如果内存不满足新加入数据的最低存储要求，redis要临时删除一些数据为当前指令清理存储空间。清理数据的策略被称为逐出算法。

但是逐出数据的过程并不能保证能够清理出足够的可使用的内存空间，如果不成功则反复执行。当对所有数据尝试完毕后，如果不能达到内存清理的要求，将出现错误信息。

# 2 数据逐出策略配置

## 2.1 配置最大可使用内存

- maxmemory
  - 允许用户设置最大使用内存大小
  - 0（默认配置）：表示不限制。
  - 生产环境中根据需求设定，通常设置在50%以上，但最好不超过内存的60%-70%。
- maxmemory-samples
  - 每次选取待删除数据的个数
  - 选取数据时并不会全库扫描，导致严重的性能消耗，降低读写性能。因此采用随机获取数据的方式作为待检测删除数据
- maxmemory-policy：删除策略
  - 达到最大内存后的，对被挑选出来的数据进行删除的策略。
  - 检测易失数据：可能会过期的数据集`server.db[i].expires`
    - volatile-lru：挑选最近最少使用的数据淘汰
    - volatile-lfu：挑选最近使用次数较少的数据淘汰
    - volatile-ttl：挑选将要过期的数据淘汰
    - volatile-random：任意选择数据淘汰
  - 检测全库数据：所有数据集`server.db[i].dict`
    - allkeys-lru：挑选最近最少使用的数据淘汰
    - allkeys-lfu：挑选最近使用次数最少的数据淘汰
    - allkeys-random：任意选择数据淘汰
  - 放弃数据驱逐
    - no-enviction：禁止驱逐数据(redis4.0默认策略)，会引发OOM（out of memory）。

# 3 数据逐出策略的选择

使用INFO命令输出监控信息，查询缓存 hit 和 miss 的次数，根据业务需求调优Redis配置。

- `keyspace_hits`：redis请求键被命中的次数
- `keyspace_misses`：redis请求键未被命中的次数