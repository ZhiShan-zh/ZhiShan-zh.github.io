# 面向切面编程

AOP（Aspect Oriented Programming）：面向切面编程

# 1 方面编程的概念

## 1.1 AOP产生的背景

### 1.1.1 面向过程编程面临的问题

**面向过程编程**是一种自顶向下的编程方法，其实质是对软件进行功能性的分解。

**适用范围**：小型软件系统。如某一算法的实现。

- 在大型应用系统中，自顶向下逐步求精的方法无论在系统体系结构的确立，系统的进化和维护，以及软件重用性方面都存在其不足之处。

### 1.1.2 传统面向对象编程面临的问题

传统的面向对象语言由于其良好的封装性、层次化性以及继承性等特性而取得了很大的成功，并且对象模型可以很好地映射到实际领域。但是，在软件生命周期中，它存在以下不足之处：

- 设计阶段：由于以类为单位组织建模，因此它不能全面地反映软件系统的需求。
- 编码阶段：将数据和方法封装到类中的思想增强了数据的安全性和软件的模块化，但是有一些数据和方法是特定于应用的，因此这种编码阶段的封装减少了代码的重用的可能性。
- 维护阶段：由于类中夹杂了各种特定于应用的代码，使得维护人员难以理解代码，此外，完成某个特定需求的代码酚酸在各个类中，当这些代码需要改变时，很难把它们全部找到，这就给程序的健壮性带来了隐患。

由于上述这些问题的产生，需要一种新的程序设计方法从更高的层次上对软件系统进行抽象，将传统的按功能或按对象划分程序模块的方法转化为**按系统特性划分程序模块**，这就是AOP的基本思想。

## 1.2 面向方面的原因

为了理解和完成一个复杂的程序，通常要把程序划分为若干较小的子程序。

当程序按实现过程编写时，应用程序依照实现的行为和步骤模块化。当使用面向对象的方法时，程序的模块化组则基于类中封装的数据。两种情况下，某些操作较难实现模块化。我们称涉及到这些操作的代码是分散的。

AOP主要的贡献在于在某一方面提供了一种融合代码的方式——否则这些代码会分散在整个应用程序中。

**方面的定义**：一个设计来用于捕捉应用程序横切面功能的程序单位。

当对一个问题建模时，

- 人们用类来表示对象（顾客、命令和提供者等）的种类，且每个对象包含适当的数据（属性）和过程（操作）。
- 方面用于实现一个应用程序中的功能性（安全性、持续性、日志记录等等），而这些功能性要求同样的数据和处理。

使用AOP时，一个应用程序包含各个类和方面。方面和类的不同在于它实现了横切程序的功能。在面向过程和面向对象的案例中，横切的功能就是那些遍及应用程序的代码。

程序中包括类和方面意味着模块化可以在两个因素上实现：

- 类实现基本的功能性（这个因素叫做结构性）
- 方面实现横切的功能性（这个因素叫做可操作性）  

## 1.3 AOP技术

AOP可以说是OOP（Object-Oriented Programming，面向对象编程）的补充和完善。

- OOP引入封装、继承和多态性等概念来建立一种对象层次结构，用以模拟公共行为的一个集合。
- 当需要为分散的对象引入公共行为时，OOP则显得无能为力。也就是说，OOP允许定义从上到下的关系，但并不适合定义从左到右的关系。
  - 如日志功能，日志代码往往水平散布在所有对象层次中，而与它所散布到的对象的核心功能毫无关系。
  - 对于其他类型的代码，如安全性、异常处理和透明的持续性也是如此。
  - 这种散布在各处的无关代码称为**横切（cross-cutting）代码**，在OOP设计中，它导致了大量代码的重复，而不利于各个模块的重用。

- AOP技术利用一种称为“横切”的技术，剖解开封装在对象内部，并将那些影响了多个类的公共行为封装到一个可重用模块，并将其命名为**Aspect**即**方面**。

  - 所谓“方面”，就是将那些于系统无关，却被业务模块所共同调用的逻辑或责任封装起来，以减少系统的重复代码，降低模块间的耦合度，并有利于未来的可操作性和可维护性。

  - 使用“横切”技术，AOP把软件系统分为两个部分：

    - 核心关注点：业务处理的主要流程。

    - 横切关注点：主业务处理主要流程关系不大的部分。
      - 其一个特点是：其经常发生在核心关注点的多出，而各处都基本相似，例如权限认证、日志、事务处理。
    - **AOP的作用**：分离系统中的各种关注点，将核心关注点和横切关注点分离开来。

实现AOP的技术，主要分为两大类：

- 采用动态代理技术：利用截取消息的方式，对该消息进行装饰，以取代原有对象行为的执行。
- 采用静态织入的方式：引入特定的语法创建“方面”，从而使得编译器可以在编译期间植入有关“方面”的代码。

殊途同归，实现AOP的技术特性是相同的。

1. **join point（连接点）**：是程序执行中的一个精确执行点，例如类中的一个方法。它是一个抽象的概念，在实现AOP时，并不需要去定义一个join point。
2. **point cut（切入点）**：本质上是一个捕获连接点的结构。在AOP中，可以定义一个point cut，来捕获相关方法的调用。
3. **advice（通知）**：是point cut的执行代码，是执行“方面”的具体逻辑。
4. **aspect（方面）**：point cut和advice结合起来就是aspect，它类似于OOP中定义的一个类，但它代表的更多的是对象间横向的关系。
5. **introduce（引入）**：为对象引入附加的方法或属性，从而达到修改对象结构的目的。有的AOP工具又将其称为mixing。

## 1.4 AOP特性

衡量软件质量高低的要素主要包括：可靠性、可扩展性、可重用性、兼容性以及易用性、易维护性等。

AOP的特性：

- 可扩展性：指软件系统在需求更改时程序的易更改能力。
  - OOP主要通过提供继承和重载机制来提高软件的可扩展性，因此它的扩展性体现在类一级。
  - AOP提供系统的扩展机制，通过扩展Aspect（AspectJ支持Aspect的继承机制）或增加Aspect，系统相关的各个部分随之产生变化。
    - 由此带来的另一个好处是在软件测试中，通过屏蔽某些Aspect，可以大大简化软件的测试复杂度，提高测试精度。
- 可重用性：是指某个应用系统中的元素被应用到其他系统的能力。
  - OOP：
    - OOP的类机制作为一种抽象数据类型，提供了比过程化更好的重用性。泛化机制也使可重用性得到很大提高。
    - OOP所提供的重用性对非特定于系统的功能模块有很好的支持，如对堆栈的操作或窗口机制的实现等。
    - 但在特定于系统的功能模块中，一个类通常包含很多应用相关的数据及对其的操作，此时类的重用性变得十分困难。
    - OOP的重用性也限于类一级，对于不能封装成类的元素，如异常处理等，很难实现有效的重用。
  - AOP中的系统模块包括系统组件和影响这些组件的特性，通过将实现基本功能的组件和特定于应用的系统特性分离，使得组件（包括类或者函数）的重用性得到提高，并使不能封装为类或函数的系统元素（Aspect）的重用性称为可能。
- 易理解性和易维护性：
  - 在OOP中，类机制的引入使其具有比过程编程更好的模块性，因此也更易于被程序员理解和维护。
  - 对于AOP，对于一个aspect的修改可以通过联结器影响到系统相关的各个部分，从而大大提高了系统的易维护性。另外，对系统特性的模块化封装无疑也能提高程序的易理解性。

## 1.5 AOP程序设计

### 1.5.1 AOP程序结构

基于AOP的应用程序结构与传统高级语言的应用程序结构基本类似：

- 传统的高级语言系统实现由以下三部分组成：
  - 一种编程语言。
  - 特定于这种语言的编译器。
  - 利用这种语言编写的应用程序。
- 基于AOP的系统实现也有以上三个主要部分，但由于AOP中有了动态aspect的概念，因此可进一步细化为如下部分：
  - 一种组件语言，一种或多种aspect语言。
  - 一个用来合并两者的aspect编织器（weaver）。
  - 利用组件语言实现的系统组件，利用aspect实现的aspect组件。

### 1.5.2 AOP的程序设计步骤

- 将系统需求进行功能性分解，区分出普通关注点以及横切关注点，确定那些功能使组件语言必须实现的，那些功能可以以aspect的形式动态加入到系统组件中。
- 单独完成每一个关注点的编码和实现，构造系统组件和系统aspect。
  - 这里的系统组件，是实现该系统的基本模块：
    - 对OOP语言，这些组件可以是类；
    - 对于过程化程序设计语言，这些组件可以是各种模块和API。
  - 系统aspect是指用AOP语言实现的将横切关注点封装成的独立的模块单元。
- 用联结器指定的重组规则，将组件代码和aspect代码进行组合，形成最终系统。
  - 为达到此目的，应用程序需要利用或创造一种专门指定规则的语言，用它来组合不同应用程序片段。
    - 这种用来指定联结规则的语言可以是一种已有编程语言的扩展，也可以是一种完全不同的全新语言。

## 1.6 AOP的优势

 ## 1.7 当前的AOP技术

AOP是一种概念，不同的技术可以有不同的实现。

- 在语法方面：
  - AspectWerkz、JBoss AOP和Spring AOP都在没有改变Java语言语法的情况下加入了方面语义；
  - 而AspectJ则对Java语言进行了扩展。
- 在声明方式：
  - AspectJ在代码中对方面进行声明。
  - AspectWerkz和JBoss AOP支持元数据对Java代码进行注释，或者在独立的XML文件中对方面进行声明。
  - Spring AOP，则完全用XML对方面进行声明，比起AspectWerkz和JBoss AOP，Spring AOP提供了更加精细的配置。
- 在性能方面：
  - AspectJ通过编译时对目标二进制类的增强获得面向方面的能力，所以在编译时会带来开销，运行时可获得更快的速度。
  - JBossAOP和SpringAOP基于拦截技术则在运行时有更多的工作要做。
  - 对比之下，AspectJ的构建时开销最多，AspectWerkz次之，JBossAOP再次，SpringAOP没有构建时开销。

# 2 AspectJ



# 3 Spring AOP

