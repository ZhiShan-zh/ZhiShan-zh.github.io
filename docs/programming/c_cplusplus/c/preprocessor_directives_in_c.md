# C语言预处理命令

# 1 概述

ANSI C标准规定可以在C源程序中加入一些“预处理命令”（preprocessor directives），以改进程序设计环境，提高编程效率。这些预处理命令是由ANSI C统一规定的，但是它不是C语言本身的组成部分，不能直接对他们进行编译（因为编译程序不能识别它们）。必须在对程序进行通常的编译（包括此法和语法分析、代码生成、优化等）之前，先对程序中的这些特殊的命令进行“预处理”，即根据预处理命令对程序作相应的处理。

经过预处理后的程序不再包含预处理命令了，最后再由编译程序对预处理后的源程序进行通常的编译处理，得到可供执行的目标代码。

C语言提供的预处理功能主要包括以下3种：

1. 宏定义：用一个指定的标识符（即名字）来代表一个字符串，其一般形式为：`#define 标识符 字符串`

2. 文件包含：指一个源文件可以将另一个源文件的全部内容包含进来，即将另外的文件包含到本文件之中。其一般形式为：`#include "文件名"` 、`#include <文件名>`

3. 条件编译：程序中的一部分内容只在满足一定条件时才进行编译。其一般形式为：

   ```c
   #ifdef 标识符
   	程序段1
   #else
       程序段2
   #endif
   ```

# 2 宏定义

## 2.1 不带参数的宏定义

定义：用一个指定的标识符（即名字）来代表一个字符串。

一般形式：`#define 标识符 字符串`

示例：`#define PI 3.1415926`

作用：是在程序文件中用指定的**标识符**（如PI）来代替指定的**字符串**（如“3.1415926”），在编译预处理时，将程序中的PI都用“3.1415926”代替。这种方法使用户能以一个简单的名字代替一个长的字符串，因此把这个标识符（名字）成为“宏名”，在预处理时将宏名换成字符串的过程称为“宏展开”。

说明：

1. 宏名一般习惯用大写字母表示，以便与变量名相区别，但这并非规定，也可以用小写字母。

2. 使用宏名代替一个字符串，可以减少程序中重复书写某些字符串的工作量。并且用宏名代替一个，简单而不易出错，因为记住一个宏名要比记住一个无规律的字符串容易，而且在都程序时能立即知道它的涵义。

3. 宏定义是用一个宏名代替一个字符串，也就是作简单的置换，不做正确性检查。预处理不作任何语法检查，只有在编译已被宏展开后的源程序时才能发现语法错误并报错。

4. 宏定义不是C语言，不必再行行尾加分号。如果加了分号则会连分号一起进行置换。

5. `#define`命令出现再程序中函数的外面，宏名的有效范围为定义命令之后到本文件结束。

6. 可以用`#undef`命令终止宏定义的作用域。

7. 在进行宏定义的时候，可以引用已定义的宏名，可以层层置换。

   ```c
   #define R 3.0
   #define PI 3.1415926
   #define L 2*PI*R
   ```

8. 对程序中用双撇号括起来的字符串内的字符，即使与宏名相同，也不进行置换。

   ```c
   #include <stdio.h>
   #define PI 3.1415926
   
   int main(){
       printf("PI*r=%f", PI*3.0);
       return 0;
   }
   ```

   输出：PI*r=9.424778

9. 宏定义是专门用于预处理命令的一个专用名词，它与定义变量的含义不同，只作字符替换，不分配内存空间。

## 2.2 带参数的宏定义

**定义**：带参数的宏定义不是进行简单的字符串替换，还要进行参数替换。

**一般形式**：`#define 宏名(参数表) 字符串`

示例：

```c
#define S(a,b) a*b

void main(){
    int area = S(3,2);
}
```

**对带参数的宏定义是这样展开置换的**：在程序中如果有带实参的宏（如`S(a,b)`），则按`#define`命令行中指定的字符串从左到右进行置换。如果串中包含宏中的形参（如a、b），则将程序语句中相应的实参（可以是常量、变量或表达式）代替形参。如果宏定义中的字符串中的字符不是参数字符（如`a*b`中的`*`），则保留。

**说明**：

1. 对带参数的宏的展开只是将语句中的宏名后面括号内的实参字符串代替`#define`命令行中的形参。
2. 在宏定义时，在宏名与带参数的括号之间不应加空格；否则将空格以后的字符都作为替代字符串的一部分。

**带参数的宏定义与函数时不同的**：

1. 函数调用时，先求出实参表达式的值，然后代入形参。而使用带参数的宏只是进行简单的字符替换。

2. 函数调用实在程序运行时处理的，为形参分配临时得内存单元。而宏展开则是在编译前进行的，在展开时并不分配内存单元，不进行值得传递处理，也没有“返回值”的概念。

3. 对函数的实参和形参都需要定义类型，二者要求严格一致，如不一致，应进行类型转换。而**宏不存在类型问题，宏名无类型，它的参数也无类型，只是一个符号代表，展开时代入指定的字符串即可。宏定义时，字符串可以是任何类型的数据。**

4. **调用函数只可得到一个返回值，而用宏可以设法得到几个结果**。

   ```c
   
   ```

   

5. 使用宏次数多时，宏展开后源程序变长，因为每展开一次都使程序增长，而函数调用不会使源程序变长。

6. 宏替换不占运行时间，只占用编译时间。而函数调用则占用运行时间（分配单元、保留现场、值传递、返回）。

7. 在进行带参数宏定义的时候，也可以引用已定义的带参数宏定义的宏名，可以层层置换。

   ```c
   #include <stdio.h>
   
   #define FUN(index1,index2) index1*index2
   #define SUM(index1,index2) FUN(index1,index2)+FUN(index1,index2)
   
   int main(){
       int sum = SUM(2,2);
       printf("sum=%d\n", sum);//输出sum=8
       return 0;
   }
   ```

   

## 2.3 使用宏实现泛型编程

实现原理：宏不存在类型问题，宏名无类型，它的参数也无类型，只是一个符号代表，展开时代入指定的字符串即可。宏定义时，字符串可以是任何类型的数据。

缺点：宏定义并不进行完备的检测，若不小心使用，很容易会出现意想不到的错误。



